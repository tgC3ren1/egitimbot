<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bonus Hesaplama â€¢ zbahis</title>
  <link rel="icon" href="logo.png">
  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: { brand1:'#ff6a3a', brand2:'#00e0ff' }
        }
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{ color-scheme: dark; }
    html,body{height:100%}
    body{
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,106,58,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(0,224,255,.14), transparent 60%),
        linear-gradient(180deg, #0b1220 0%, #0e1628 100%);
      color:#e6edf6;
    }
    .glass{ backdrop-filter: blur(10px); background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08) }
    .card{ border-radius:1rem; padding:1.5rem; }
    .inp,.sel{
      width:100%; padding:.5rem .75rem; border-radius:.75rem;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); color:#fff; outline:none;
    }
    .inp::placeholder{ color:rgba(255,255,255,.4) }
    .inp:focus,.sel:focus{ box-shadow:0 0 0 2px rgba(0,224,255,.6) inset }
    /* AÃ§Ä±lÄ±r listede okunabilirlik */
    select.sel option, select.sel optgroup{ color:#0b1220; background:#fff; }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:.65rem 1.25rem; border-radius:.9rem; font-weight:700;
      background: linear-gradient(90deg, #ff6a3a, #00e0ff); color:#08111f;
      box-shadow: 0 10px 25px rgba(0,224,255,.15);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{ filter:brightness(1.05); transform:translateY(-1px); }
    .muted{ color:rgba(255,255,255,.6) }
    .grid-cards{ display:grid; gap:1rem }
    @media (min-width: 768px){ .grid-cards{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
    .title-grad{ background: linear-gradient(90deg,#fff 0%, #b6f3ff 60%, #7de2ff 100%); -webkit-background-clip: text; background-clip:text; color:transparent; }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .6rem; border-radius:9999px; font-size:.9rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1) }
    .raw{ font-size:.8rem; color:rgba(255,255,255,.6); margin-top:.4rem }
  </style>
</head>
<body class="font-sans">
  <!-- HEADER -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-4">
    <div class="flex items-center gap-4">
      <img src="logo.png" alt="zbahis" class="h-10 w-auto select-none">
      <h1 class="text-2xl md:text-3xl font-extrabold title-grad tracking-tight">Bonus Hesaplama</h1>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto px-4 pb-16 space-y-6">
    <!-- Controls -->
    <section class="card glass">
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="block text-sm font-medium mb-1">Bonus</label>
          <select id="bonus" class="sel"></select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Alan (opsiyonel)</label>
          <select id="domain" class="sel">
            <option value="all">TÃ¼mÃ¼ (spor, casino, slot, uÃ§ak)</option>
            <option value="spor">Spor</option>
            <option value="casino">Casino</option>
            <option value="slot">Slot</option>
            <option value="ucak">UÃ§ak / Ã–zel Oyun</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">YatÄ±rÄ±m</label>
          <input id="deposit" class="inp" placeholder="Ã¶rn. 5000 veya 1.2k" inputmode="decimal">
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">YÃ¼zde (opsiyonel)</label>
          <input id="percent" class="inp" placeholder="%25 / 25 / yÃ¼zde 25" inputmode="decimal">
          <p class="muted text-xs mt-1">Yazmazsan: Ä°lk YatÄ±rÄ±m %100, AyrÄ±calÄ±klÄ± GÃ¼n &amp; Challenge %25.</p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">KazanÃ§/Bonus TL (opsiyonel)</label>
          <input id="winnings" class="inp" placeholder="Ã¶rn. 1200 (Bonus Buy/Freespin iÃ§in Ã¶nerilir)" inputmode="decimal">
        </div>

        <div id="threeBox" class="hidden">
          <label class="block text-sm font-medium mb-1">3 YatÄ±rÄ±m</label>
          <input id="three" class="inp" placeholder="1000 1500 2000  |  toplam 6000">
        </div>
      </div>

      <div class="mt-5 flex items-center gap-3">
        <button id="calc" class="btn">Hesapla</button>
        <span id="status" class="muted text-sm"></span>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="space-y-4"></section>
  </main>

  <!-- SCRIPTS -->
  <script>
  // ====== utils ======
  const TL = n => new Intl.NumberFormat('tr-TR').format(Math.floor(n)) + " TL";
  const fold = t => (t||"").toString().normalize("NFKD")
    .replace(/[Ã§Ã‡]/g,"c").replace(/[ÄŸÄ]/g,"g").replace(/[Ä±Ä°]/g,"i")
    .replace(/[Ã¶Ã–]/g,"o").replace(/[ÅŸÅ]/g,"s").replace(/[Ã¼Ãœ]/g,"u").toLowerCase();
  function toNumber(str){ if(!str) return 0; let s=String(str).trim().toLowerCase().replace("tl","").replace("â‚º","");
    if(/^\d+(\.\d+)?k$/.test(s)) return parseFloat(s)*1000;
    s=s.replace(/\./g,"").replace(",","."); const m=s.match(/(\d+(?:\.\d+)?)/); return m?parseFloat(m[1]):0; }
  function parsePercentInput(v){ if(!v) return null; const t=fold(v); const m=t.match(/%?\s*(\d{1,3})/); return m?parseFloat(m[1]):null; }
  function parseNumbersFree(text){ const out=[]; for(const m of text.matchAll(/(\d+(?:[.,]\d+)?)\s*k\b/gi)) out.push(parseFloat(m[1].replace(",","."))*1000);
    for(const m of text.matchAll(/\d+(?:[.,]\d+)?/g)) out.push(parseFloat(m[0].replace(".","").replace(",","."))); return out; }

  // ====== rule parsing ======
  function norm(s){ return (s||"").toString().toLowerCase().replace(/Ã—/g,"x").replace(/\s+/g,""); }
  function parseRuleCell(cell){
    if(cell==null || (typeof cell==="number"&&Number.isNaN(cell))) return {basis:"NONE",multiplier:0,dep_mult:null,bonus_mult:null,raw:""};
    const s=String(cell).trim(), n=norm(s);
    if(n==="x"||n==="âœ—"||n.includes("yok")) return {basis:"NONE",multiplier:0,dep_mult:null,bonus_mult:null,raw:s};
    if(n.includes("cevrimsiz")||n.includes("Ã§evrimsiz")) return {basis:"BONUS",multiplier:0,dep_mult:null,bonus_mult:null,raw:s};
    let m=n.match(/yat[Ä±i]r[Ä±i]mx?(\d+)\+bonusx?(\d+)/); if(m) return {basis:"COMBO",multiplier:0,dep_mult:+m[1],bonus_mult:+m[2],raw:s};
    const n2=s.toLowerCase().replace(/\s+/g,"");
    if((n2.includes("freespin")&&n2.includes("kazanc"))||(n2.includes("bonusbuy")&&n2.includes("kazanc"))){
      const k=n2.split("kazanc")[1].match(/x?(\d+)/); if(k) return {basis:"DEPOSIT_PLUS_BONUS",multiplier:+k[1],dep_mult:null,bonus_mult:null,raw:s};
    }
    m=n.match(/toplam(bakiye|baz|balance)x?(\d+)/); if(m) return {basis:"DEPOSIT_PLUS_BONUS",multiplier:+m[2],dep_mult:null,bonus_mult:null,raw:s};
    m=n.match(/yat[Ä±i]r[Ä±i]m\+?bonusx?(\d+)/); if(m) return {basis:"DEPOSIT_PLUS_BONUS",multiplier:+m[1],dep_mult:null,bonus_mult:null,raw:s};
    if(/yat[Ä±i]r[Ä±i]m[Ä±i]n?1kat[Ä±i]/.test(n)||/1x*yat[Ä±i]r[Ä±i]m/.test(n)||/yat[Ä±i]r[Ä±i]m1x*/.test(n)||/yat[Ä±i]r[Ä±i]m%*100/.test(n)) return {basis:"DEPOSIT",multiplier:1,dep_mult:null,bonus_mult:null,raw:s};
    m=n.match(/yat[Ä±i]r[Ä±i]mx?(\d+)/); if(m) return {basis:"DEPOSIT",multiplier:+m[1],dep_mult:null,bonus_mult:null,raw:s};
    m=n.match(/(?:^|[^a-z])(bonus)x?(\d+)/); if(m) return {basis:"BONUS",multiplier:+m[2],dep_mult:null,bonus_mult:null,raw:s};
    return {basis:"NONE",multiplier:0,dep_mult:null,bonus_mult:null,raw:s};
  }

  // ====== percent logic ======
  function percentFromTitleOrShort(p){
    for(const t of [p.title,p.short]){ if(!t) continue;
      const m=t.match(/%\s*(\d{1,3})/); if(m) return +m[1];
      if(/limitsiz/i.test(t)){ const m2=t.match(/\b(\d{1,3})\b/); if(m2) return +m2[1]; }
    } return null;
  }
  function percentDefaultOverride(p){ const n=fold((p.short||p.title||"")); if(n.includes("ilk yatirim")) return 100; return null; }
  function percentSpecificOverride(p){
    const n=fold((p.short||p.title||""));
    if(n.includes("ayricalikli")&&n.includes("gun")) return 25;
    if(n.includes("challenge")) return 25;
    if(n.includes("her gun bonus")) return 100; /* Her GÃ¼n Bonus varsayÄ±lan %100 */
    return null;
  }
  function percentFromTieredNotes(p,deposit){
    const notes=p.notes||""; if(!notes) return null; const t=notes.replace(/[â€”â€“]/g,"-"); const ranges=[];
    for(const m of t.matchAll(/(\d[\d\.\,]*)\s*-\s*(\d[\d\.\,]*)[^%]*%\s*(\d{1,3})/g)){ ranges.push({lo:toNumber(m[1]),hi:toNumber(m[2]),pc:+m[3]}); }
    for(const m of t.matchAll(/(\d[\d\.\,]*)\s*(?:tl)?\s*\+\s*[^%]*%\s*(\d{1,3})/gi)){ ranges.push({lo:toNumber(m[1]),hi:Infinity,pc:+m[2]}); }
    if(!ranges.length) return null;
    for(const r of ranges){ if(r.lo<=deposit && deposit<=r.hi) return r.pc; }
    const plus=ranges.filter(r=>r.hi===Infinity).map(r=>r.pc); return plus.length?Math.max(...plus):null;
  }
  function birthdayGift(p){ const n=fold((p.short||p.title||"")); return (n.includes("dogum")&&n.includes("gun"))?1000:null; }

  // ====== compute ======
  function parseMaxBonusValue(s){ if(!s) return null; const t=s.trim().toLowerCase(); if(t.includes("limit yok")||t.includes("limitsiz")||t==="-" ) return null; const v=toNumber(t); return v>0?v:null; }
  function parseMinDepositValue(s){ const v=toNumber(s); return v>0?v:null; }

  function computeWithBonus(preset,domain,deposit,bonusAmount,opts={}){
    const rule=preset.rules[domain]; if(!rule||rule.basis==="NONE") return {error:`Bu bonus '${domain}' alanÄ±nda geÃ§ersiz.`};
    // Max bonus tavanÄ± (CSV + ekstra kural)
    let bonusCap = parseMaxBonusValue(preset.max_bonus);
    if(opts.extraBonusCap!=null){ bonusCap = (bonusCap==null) ? opts.extraBonusCap : Math.min(bonusCap, opts.extraBonusCap); }
    if(bonusCap!=null && bonusAmount>bonusCap) bonusAmount=bonusCap;

    let base=0,mult=0,required=0,combo=null;
    if(rule.basis==="COMBO"){
      required=(deposit*(rule.dep_mult||0))+(bonusAmount*(rule.bonus_mult||0));
      base=deposit+bonusAmount; combo=[rule.dep_mult,rule.bonus_mult];
    }else{
      mult=+rule.multiplier;
      if(mult===0){ base=0; required=0; }
      else{
        if(rule.basis==="BONUS"){ base=bonusAmount; }
        else if(rule.basis==="DEPOSIT"){ base=deposit; }
        else { // DEPOSIT_PLUS_BONUS
          let depPart = deposit;
          // YatÄ±rÄ±m FS: yatÄ±rÄ±m katkÄ±sÄ± max 1.000 TL
          const isYatirimFS = fold(preset.short+preset.title).includes("yatirim fs");
          if(isYatirimFS && opts.capDepositPart!=null) depPart = Math.min(depPart, opts.capDepositPart);
          base = depPart + bonusAmount;
        }
        required = base * mult;
      }
    }
    return {domain,deposit:Math.floor(deposit),bonus:Math.floor(bonusAmount),base:Math.floor(base),multiplier:mult,required:Math.floor(required),rule_raw:rule.raw,combo};
  }

  function computePercent(preset,domain,deposit,percent,opts={}){
    let bonus=deposit*(percent/100);
    // ekstra tavan (Ã¶r. Her GÃ¼n Bonus 2.000 TL)
    let cap = parseMaxBonusValue(preset.max_bonus);
    if(opts.extraBonusCap!=null){ cap = (cap==null)?opts.extraBonusCap:Math.min(cap, opts.extraBonusCap); }
    if(cap!=null && bonus>cap) bonus=cap;
    return computeWithBonus(preset,domain,deposit,bonus,opts);
  }

  function computeAll(preset,deposit,resolver){
    const out=[]; for(const dom of ["spor","casino","slot","ucak"]){
      const r=preset.rules[dom]; if(!r||r.basis==="NONE") continue; out.push([dom,resolver(dom)]);
    } return out;
  }

  // ====== CSV load ======
  const state={presets:{},order:[]};
  async function loadCSV(){ return new Promise((res,rej)=>Papa.parse("bonus_kurallari_kisaisim.csv",{download:true,header:true,skipEmptyLines:true,complete:res,error:rej})); }
  function buildPresets(rows){
    const col = name => Object.keys(rows[0]).find(c=>fold(c)===fold(name)) || Object.keys(rows[0]).find(c=>fold(c).includes(fold(name)));
    const C={ title:col("Bonus AdÄ±"), short:col("KÄ±sa Ä°sim"), spor:col("Spor Ã‡evirim"), casino:col("Casino Ã‡evirim"), slot:col("Slot Ã‡evirim"),
      ucak: col("UÃ§ak / Ã–zel Oyun Ã‡evirim")||col("UÃ§ak Oyunu")||col("UÃ§ak"),
      min:col("Min. YatÄ±rÄ±m"), maxb:col("YatÄ±rÄ±m / Max. Bonus")||col("Max. Bonus"), maxw:col("Max. Ã‡ekim"), notes:col("Ã–zel Kurallar") };
    const presets={}, order=[];
    for(const r of rows){
      const p={ title:r[C.title]||"", short:(r[C.short]||r[C.title]||"").toString().trim(),
        rules:{ spor:parseRuleCell(r[C.spor]), casino:parseRuleCell(r[C.casino]), slot:parseRuleCell(r[C.slot]), ucak:parseRuleCell(r[C.ucak]) },
        min_deposit:(r[C.min]||"").toString().trim()||null, max_bonus:(r[C.maxb]||"").toString().trim()||null, max_withdraw:(r[C.maxw]||"").toString().trim()||null, notes:(r[C.notes]||"").toString().trim()||null };
      presets[p.short]=p; order.push(p.short);
    }
    state.presets=presets; state.order=order.sort((a,b)=>{
      const aa=(presets[a].title||a), bb=(presets[b].title||b);
      return fold(aa).localeCompare(fold(bb));
    });
  }

  function fillBonusSelect(){
    const sel=document.getElementById("bonus");
    sel.innerHTML=state.order.map(k=>{
      const p=state.presets[k]; const label=p.title||p.short||k;
      return `<option value="${k}">${label}</option>`;
    }).join("");
    sel.dispatchEvent(new Event("change"));
  }

  // ====== UI handlers ======
  document.getElementById("bonus").addEventListener("change", e=>{
    const key=e.target.value;
    const preset=state.presets[key];
    const isThree=fold(preset.short+preset.title).includes("3 yatirim");
    document.getElementById("threeBox").classList.toggle("hidden", !isThree);

    // DoÄŸum GÃ¼nÃ¼ seÃ§ilince otomatik 1000 TL
    const isBday = fold(preset.short+preset.title).includes("dogum") && fold(preset.short+preset.title).includes("gun");
    if(isBday){ document.getElementById("winnings").value = "1000"; }
  });

  document.getElementById("calc").addEventListener("click", ()=>{
    const key=document.getElementById("bonus").value;
    const preset=state.presets[key]; if(!preset) return;

    const domain=document.getElementById("domain").value;
    const percentIn=parsePercentInput(document.getElementById("percent").value);
    const winningsIn=toNumber(document.getElementById("winnings").value);
    const deposit=toNumber(document.getElementById("deposit").value);
    const resultsDiv=document.getElementById("results"); resultsDiv.innerHTML=""; document.getElementById("status").textContent="";

    const isBday = !!birthdayGift(preset);            // DoÄŸum GÃ¼nÃ¼
    const isDaily = fold(preset.short+preset.title).includes("her gun bonus"); // Her GÃ¼n Bonus
    const isYatirimFS = fold(preset.short+preset.title).includes("yatirim fs");

    // DoÄŸum GÃ¼nÃ¼ â€“ hediye 1000, Ã§evrim yok
    if(isBday){
      const gift=1000;
      resultsDiv.innerHTML = `
        <div class="card glass">
          <div class="text-lg font-semibold">ğŸ‰ ${preset.title || preset.short}</div>
          <div class="mt-2">ğŸ Hediye: <b>${TL(gift)}</b> â€” âœ… Ã‡evrim yok.</div>
          <div class="mt-2">ğŸ¯ Slot alanÄ±nda <b>2.500 TL</b> yapÄ±p Ã§ekebilir.</div>
          <div class="muted text-sm mt-2">ğŸ“ Son 3 ayda en az <b>1.000 TL</b> yatÄ±rÄ±mÄ± olmasÄ± gereklidir.</div>
        </div>`;
      return;
    }

    // YatÄ±rÄ±m boÅŸsa uyar
    if(!deposit){ document.getElementById("status").textContent="LÃ¼tfen yatÄ±rÄ±m girin."; return; }

    const icon={spor:"âš½",casino:"ğŸ°",slot:"ğŸ§©",ucak:"âœˆï¸"};
    const mindep=parseMinDepositValue(preset.min_deposit);

    function renderCards(pairs, header, extraNoteHTML=""){
      const cards=pairs.map(([dom,r])=>{
        if(r.error) return `<div class="card glass"><div class="font-semibold">${icon[dom]} ${dom.toUpperCase()}</div><div class="mt-2 text-rose-300">${r.error}</div></div>`;
        const chips=[
          preset.min_deposit?`<span class="chip">Min: ${preset.min_deposit}</span>`:"",
          preset.max_bonus?`<span class="chip">Max bonus: ${preset.max_bonus}</span>`:"",
          preset.max_withdraw?`<span class="chip">Max Ã§ekim: ${preset.max_withdraw}</span>`:""
        ].filter(Boolean).join(" ");
        const combo=r.combo?`<div class="raw">Kombine: YatÄ±rÄ±mÃ—${r.combo[0]} + BonusÃ—${r.combo[1]}</div>`:"";
        const raw=r.rule_raw?`<div class="raw">ğŸ§© ${r.rule_raw}</div>`:"";
        return `<div class="card glass">
          <div class="font-semibold">${icon[dom]} ${dom.toUpperCase()}</div>
          <div class="mt-2">Baz: <b>${TL(r.base)}</b> â€¢ x${r.multiplier||"â€”"} â†’ âœ… <b>${TL(r.required)}</b></div>
          <div class="mt-2 flex flex-wrap gap-2">${chips}</div>
          ${combo}${raw}
        </div>`;
      }).join("");
      resultsDiv.innerHTML = `
        <div class="card glass">
          <div class="text-lg font-semibold">${header.title}</div>
          <div class="muted">${header.subtitle}</div>
          ${extraNoteHTML}
        </div>
        <div class="grid-cards">${cards}</div>
        ${mindep && deposit<mindep ? `<div class="muted text-sm">âš ï¸ Min. yatÄ±rÄ±m ${TL(mindep)} (girilen ${TL(deposit)} altÄ±nda)</div>`:""}
      `;
    }

    // Ã–ncelik: winnings â†’ percent â†’ heuristics
    const optsBase = {
      extraBonusCap: isDaily ? 2000 : null,              // Her GÃ¼n Bonus: max 2.000 TL
      capDepositPart: isYatirimFS ? 1000 : null          // YatÄ±rÄ±m FS: yatÄ±rÄ±m katkÄ±sÄ± max 1.000 TL
    };

    if(winningsIn>0){
      const resolver=dom=>computeWithBonus(preset,dom,deposit,winningsIn,optsBase);
      const pairs=(domain==="all")?computeAll(preset,deposit,resolver):[[domain,resolver(domain)]];
      const title = `${preset.title || preset.short} â€” KazanÃ§/Bonus: ${TL(winningsIn)}${isYatirimFS?' (YatÄ±rÄ±m katkÄ±sÄ± max 1.000 TL)':''}`;
      const note = isYatirimFS ? `<div class="raw mt-2">â„¹ï¸ YatÄ±rÄ±m kÄ±smÄ± en fazla <b>1.000 TL</b> olarak baz alÄ±nÄ±r.</div>` : "";
      renderCards(pairs,{title, subtitle:`YatÄ±rÄ±m: ${TL(deposit)}`}, note);
      return;
    }

    let pct = percentIn ?? percentSpecificOverride(preset) ?? percentDefaultOverride(preset) ?? percentFromTitleOrShort(preset) ?? percentFromTieredNotes(preset,deposit);
    if(pct==null){ document.getElementById("status").textContent="YÃ¼zde bulunamadÄ± â€” yÃ¼zde yazÄ±n ya da 'KazanÃ§/Bonus TL' girin."; return; }

    const resolver=dom=>computePercent(preset,dom,deposit,pct,optsBase);
    const pairs=(domain==="all")?computeAll(preset,deposit,resolver):[[domain,resolver(domain)]];
    const title = `${preset.title || preset.short} â€” %${parseInt(pct)}${isDaily?' (Max 2.000 TL)':''}${isYatirimFS?' (YatÄ±rÄ±m katkÄ±sÄ± max 1.000 TL)':''}`;
    const note = isYatirimFS ? `<div class="raw mt-2">â„¹ï¸ YatÄ±rÄ±m kÄ±smÄ± en fazla <b>1.000 TL</b> olarak baz alÄ±nÄ±r.</div>` : "";
    renderCards(pairs,{title, subtitle:`YatÄ±rÄ±m: ${TL(deposit)}`}, note);
  });

  (async function init(){
    try{ const parse=await loadCSV(); await buildPresets(parse.data); fillBonusSelect(); }
    catch(e){ document.getElementById("status").textContent="CSV yÃ¼klenemedi: "+e; }
  })();
  </script>
</body>
</html>
